---
title: "Final Project"
authors: "Group 4"
date: "2025-11-05"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Import packages
```{r, message=FALSE}
library(tidyverse)
library(dplyr)
library(kableExtra)
library(janitor)
library(broom)
library(lmtest)
library(stringr)
library(sf)
library(terra)
library(classInt)
library(tmap)
library(RColorBrewer)
library(spatstat)
```

# Read in the file
```{r}
dat <- read.csv('traffic-collisions-4326.csv')

# display top 6 rows
head(dat)
```
# Clean column names
```{r}
# use clean_names to clean up column names
dat_clean <- clean_names(dat)


# display top 6 rows
head(dat_clean)
```



# Clean Date Column
```{r}
# convert OCC_Date from Unix time stamp to standard date

# Convert milliseconds to seconds
date_s <- dat_clean$occ_date / 1000

# Convert to Date (drops the time)
date <- as.Date(as.POSIXct(date_s, origin = "1970-01-01", tz = "UTC"))

# assign to new date column
dat_clean$date <- date

# remove occ_date
subset(dat_clean, select = -occ_date)

# display top 6 rows
head(dat_clean)

```

# Remove codes from neighborhood_158 and create new coloumn
```{r}
dat_clean$neighbourhood <- gsub("\\s*\\([^\\)]+\\)", "", dat_clean$neighbourhood_158)

# remove original neighborhood_158 column
dat_clean <- subset(dat_clean, select = -neighbourhood_158)

#display top 6 rows
head(dat_clean)
```



# Recode binary variables to numeric
```{r}
dat_recoded <- dat_clean %>%
  mutate(across(c(injury_collisions, ftr_collisions, pd_collisions, automobile, motorcycle, passenger, bicycle, pedestrian),
                ~case_when(
                    .=="YES" ~ 1,
                    .=="NO" ~ 0,
                    is.na(.) ~ 0, # assign 0 to NA values
      )))



# recode fatalities column to set blank columns to 0
dat_recoded$fatalities[is.na(dat_recoded$fatalities)] <- 0

head(dat_recoded)

#fatalities,injury_collisions,ftr_collisions,pd_collisions,automobile,motorcycle,passenger,bicycle,pedestrian
```

# Create Final Dataset
```{r}

# rename columns
dat_renamed <- dat_recoded %>%
  rename(
    id = x_id,
    month = occ_month,
    day = occ_dow,
    year = occ_year,
    hour = occ_hour
  )

# final dataframe

dat_final <- subset(dat_renamed, select = c(id, date, day, month, year, hour,
                    neighbourhood, long_wgs84, lat_wgs84,
                    fatalities, injury_collisions, ftr_collisions,
                    pd_collisions, automobile, motorcycle, passenger, bicycle,
                    pedestrian))

head(dat_final)

```

- Time and date data is first, followed by location data, then type of collision
- ftr : fail to remain collision
- pd : property damage collision

# DESCRIPTIVE STATISTICS

# --- Inspect structure ---
``` {r}
str(dat_final)
summary(dat_final)
```
# --- Binary columns --- For easier visualizations later
``` {r}
binary_cols <- c("fatalities", "injury_collisions", "ftr_collisions", "pd_collisions",
                 "automobile", "motorcycle", "passenger", "bicycle", "pedestrian")
vehicle_cols <- c("automobile", "motorcycle", "bicycle", "pedestrian")
```
# --- Descriptive stats for binary columns ---
# Mean = proportion of 1s or YESes, SD = measure of spread (how variable yes/no are)
``` {r}
binary_summary <- dat_final %>%
  summarise(across(all_of(binary_cols),
                   list(mean = ~mean(., na.rm = TRUE),
                        sd = ~sd(., na.rm = TRUE),
                        count_1 = ~sum(. == 1, na.rm = TRUE),
                        count_0 = ~sum(. == 0, na.rm = TRUE))))
binary_summary
glimpse(binary_summary)
```
(a) Fatalities: 612 cases total — extremely low frequency but high impact.
(b) Injury Collisions: ~13.5% of all collisions — common enough to analyze temporal or spatial trends.
(c) Fail-to-Remain: 17% — suggests an important behavioral or enforcement dimension; 17% left the site
(d) Property-Damage Only: ~72% — dominates the dataset.
(e) Automobiles: ~99.5% of collisions — overwhelmingly most involved vehicle type.
(f) Motorcycles: ~0.6% — small count but potentially severe outcomes per collision.


# --- Bar plots for counts of each Vehicle ---
``` {r}
binary_counts <- dat_final %>%
  summarise(across(all_of(vehicle_cols), ~sum(. == 1, na.rm = TRUE))) %>%
  pivot_longer(cols = everything(), names_to = "variable", values_to = "count")

ggplot(binary_counts, aes(x = reorder(variable, -count), y = count, fill = variable)) +
  geom_bar(stat = "identity") +
  labs(title = "Number of Collisions by Type", x = "Collision Type", y = "Count of 'Yes'") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(labels = scales::comma)
```
Automobile has a significantly higher collision count than any other variables. A few potential reasons for this:
(1) More automobiles than other vehicles in the roads with highest accidents
(2) Automobiles usually have a bigger surface area that might contribute to collisions

# --- Mean fatalities/injuries per month ---
``` {r}
# --- Counts instead of proportions, and months in order ---
monthly_summary <- dat_final %>%
  mutate(month = factor(month, 
                        levels = c("January", "February", "March", "April", "May", "June",
                                   "July", "August", "September", "October", "November", "December"))) %>%
  group_by(month) %>%
  summarise(total_fatalities = sum(fatalities, na.rm = TRUE),
            total_injuries = sum(injury_collisions, na.rm = TRUE))

ggplot(monthly_summary, aes(x = month, y = total_injuries, fill = month)) +
  geom_bar(stat = "identity") +
  labs(title = "Total Injury Collisions by Month", x = "Month", y = "Total Collisions") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none")

```
June has the highest total collisions, with Feb, Mar and Apr as the lowest. This might be because:
(1) More people outside travelling during the summer break and (2) Winter months Feb-Apr is harsh and snowy causing less people to travel frequently throughout the week.


# --- Injury collisions by day of week ---
``` {r}
day_summary <- dat_final %>%
    mutate(day = factor(day, 
                        levels = c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday",
                                   "Saturday"))) %>%
  group_by(day) %>%
  summarise(prop_injuries = sum(injury_collisions, na.rm = TRUE))

ggplot(day_summary, aes(x = day, y = prop_injuries, fill = day)) +
  geom_bar(stat = "identity") +
  labs(title = "Total Injury Collisions by Day of Week", 
       x = "Day", y = "Total Injury Collisions") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none")
```
Fridays have the most injury collisions. Most people travel within or to different cities later in the night after office which might lead to more injury collisions.

# --- Boxplot: Daily injury collisions by month ---
```{r}
daily_summary <- dat_final %>%
   mutate(month = factor(month, 
                        levels = c("January", "February", "March", "April", "May", "June",
                                   "July", "August", "September", "October", "November", "December"))) %>%
  group_by(month, date) %>%      # assuming 'date' exists
  summarise(total_injury = sum(injury_collisions, na.rm = TRUE)) %>%
  ungroup()

ggplot(daily_summary, aes(x = month, y = total_injury, fill = month)) +
  geom_boxplot(outlier.colour = "red", outlier.shape = 16, width = 0.6) +
  labs(title = "Daily Injury Collisions by Month",
       x = "Month", y = "Daily Injury Collisions") +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")
```
Winter seasons of January, February and March have the most outliers. Possibly due to winter, darkeness, black ice.



# --- Relationship between Automobile collisions and hour ---
``` {r}
# --- Bar plot for injury collisions by hour ---
hourly_summary <- dat_final %>%
  mutate(hour = as.numeric(hour)) %>%
  group_by(hour) %>%
  summarise(total_automobile = sum(automobile, na.rm = TRUE))

ggplot(hourly_summary, aes(x = hour, y = total_automobile)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(title = "Automobile Collisions by Hour of Day", 
       x = "Hour of Day", 
       y = "Number of Automobile Collisions") +
  theme_minimal()
```
Most of the automobile collisions happened between 3pm - 5pm or 15th-17hrs. We expected higher collisions later in night when people could drive more carelessly. But higher numbers of automobiles after work hours increase the chances of collisions, even if everyone is abiding by the rules.

# --- Relationship between Motorcycle collisions and hour ---
``` {r}
# --- Bar plot for injury collisions by hour ---
hourly_summary <- dat_final %>%
  mutate(hour = as.numeric(hour)) %>%
  group_by(hour) %>%
  summarise(total_motorcycle = sum(motorcycle, na.rm = TRUE))

ggplot(hourly_summary, aes(x = hour, y = total_motorcycle)) +
  geom_bar(stat = "identity", fill = "green") +
  labs(title = "Automobile Collisions by Hour of Day", 
       x = "Hour of Day", 
       y = "Number of Automobile Collisions") +
  theme_minimal()
```
A similar graph can be seen with motorcycle collisions.

# --- Histogram of Collisions x Hours ---
``` {r}
ggplot(dat_final, aes(x = hour)) +
  geom_histogram(binwidth = 1, fill = "skyblue", color = "black") +
  labs(title = "Distribution of Collisions by Hour", x = "Hour of Day", y = "Count") +
  theme_minimal()
```
Because automobile dominates the dataset, the overall distribution of collisions by hour of day is pretty much the same.

```{r}
# --- Top 6 neighbourhoods by total collisions ---
top_neighbourhoods <- dat_final %>%
  filter(neighbourhood != "NSA") %>%  #remove 'NSA' or missing ones
  group_by(neighbourhood) %>%
  summarise(total_collisions = n()) %>%
  arrange(desc(total_collisions)) %>%
  slice_head(n = 20)

ggplot(top_neighbourhoods, aes(x = reorder(neighbourhood, total_collisions), y = total_collisions)) +
  geom_bar(stat = "identity", fill = "tomato") +
  coord_flip() + 
  labs(title = "Top 20 Neighbourhoods by Total Collisions",
       x = "Neighbourhood", 
       y = "Total Collisions") +
  theme_minimal()
```
A horizontal bar graph (accommodating readability due to the length of neighbourhood names) reveals Wexford/Maryvale having significantly higher total collisions. With West Humber and York University Heights coming second and third. Everything else were clustered relatively closely and decreased.
# --- Scatterplot: total injury vs property-damage collisions per month ---
```{r}
scatter_data <- dat_final %>%
  group_by(month) %>%
  summarise(injury = sum(injury_collisions, na.rm = TRUE),
            property_damage = sum(pd_collisions, na.rm = TRUE))

ggplot(scatter_data, aes(x = injury, y = property_damage, label = month)) +
  geom_point(color = "darkred", size = 3) +
  geom_text(vjust = -0.5, size = 3) +
  labs(title = "Relationship Between Injury and Property-Damage Collisions by Month",
       x = "Injury Collisions", y = "Property-Damage Collisions") +
  theme_minimal()
```
The points are too scattered and can be deduced that there is no relation.

``` {r}
# --- Scatterplot: Fatalities vs Injury Collisions ---
scatter_fatal <- dat_final %>%
  group_by(month) %>%
  summarise(
    total_fatalities = sum(fatalities, na.rm = TRUE),
    total_injury = sum(injury_collisions, na.rm = TRUE)
  )

ggplot(scatter_fatal, aes(x = total_injury, y = total_fatalities, label = month)) +
  geom_point(color = "darkred", size = 3) +
  geom_text(vjust = -0.5, size = 3) +
  labs(
    title = "Relationship between Fatalities and Injury Collisions (by Month)",
    x = "Total Injury Collisions",
    y = "Total Fatalities"
  ) +
  theme_minimal()

```
There is a slight positive relation between injury collisions and fatalities. Indicating that collisions that caused injury often led to fatalities.

# ---Prep-Regression---
library(lubridate)

# Convert timestamp to actual date
dat_raw$occ_date2 <- as.POSIXct(dat_raw$occ_date / 1000, origin = "1970-01-01")

# Extract month number (1–12)
dat_raw$occ_month <- month(dat_raw$occ_date2)

# (Optional) Month name
dat_raw$occ_month_name <- month(dat_raw$occ_date2, label = TRUE, abbr = FALSE)

# Check if month looks correct
table(dat_raw$occ_month)
head(dat_raw[, c("occ_date", "occ_date2", "occ_month")])

# Convert necessary predictors to numeric (if not already)
dat_raw$occ_hour <- as.numeric(dat_raw$occ_hour)

library(dplyr)

# Create top 20 neighbourhood list
top20 <- dat_raw %>%
  count(neighbourhood_158, sort = TRUE) %>%
  slice(1:20) %>%
  pull(neighbourhood_158)

dat_raw$neighbourhood_top20 <- ifelse(
  dat_raw$neighbourhood_158 %in% top20,
  dat_raw$neighbourhood_158,
  "Other"
)

dat_raw$neighbourhood_top20 <- factor(dat_raw$neighbourhood_top20)

head(dat_raw)


# ---Regression---

library(dplyr)

# Aggregate collision counts by month and year
monthly_data <- dat_raw %>%
  group_by(occ_year, occ_month) %>%
  summarise(collisions = n()) %>%
  ungroup()

head(monthly_data)

# Run regression predicting number of collisions
model_trend <- lm(
  collisions ~ occ_month + occ_year,
  data = monthly_data
)

summary(model_trend)

# ---Time Series Plot---
ggplot(monthly_data, aes(x = as.Date(paste(occ_year, occ_month, "01", sep = "-")), 
                         y = collisions)) +
  geom_line(color = "steelblue", size = 1) +
  labs(
    title = "Monthly Collision Trend in Toronto",
    x = "Date",
    y = "Number of Collisions"
  ) +
  theme_minimal()

# ---Seasonality Plot---
```{r seasonality_plot}
library(dplyr)

seasonality_data <- monthly_data %>%
  group_by(occ_month) %>%
  summarise(avg_collisions = mean(collisions))

ggplot(seasonality_data, aes(x = factor(occ_month), y = avg_collisions)) +
  geom_bar(stat = "identity", fill = "darkorange") +
  labs(
    title = "Seasonal Pattern in Collisions (Monthly Average)",
    x = "Month (1–12)",
    y = "Average Number of Collisions"
  ) +
  theme_minimal()

# ---Forecasted Collision Trends---
library(dplyr)
library(ggplot2)
library(lubridate)

# Ensure monthly_data has a proper Date column
monthly_data <- monthly_data %>%
  mutate(date = as.Date(paste(occ_year, occ_month, "01", sep = "-")))

# Identify the last month in the historical dataset
last_date  <- max(monthly_data$date)
last_year  <- as.numeric(format(last_date, "%Y"))
last_month <- as.numeric(format(last_date, "%m"))

# Generate the next 24 months of future dates
future_dates <- data.frame(
  date = seq(
    from = last_date %m+% months(1),   # the month following the last historical record
    by = "1 month",
    length.out = 24
  )
)

# Extract year and month for prediction (required by model_trend)
future_dates$occ_year  <- as.numeric(format(future_dates$date, "%Y"))
future_dates$occ_month <- as.numeric(format(future_dates$date, "%m"))

# Predict collisions for the future 24 months
future_dates$predicted_collisions <- predict(model_trend, newdata = future_dates)

# Prepare historical and forecast data for plotting
plot_data <- monthly_data %>%
  mutate(type = "Historical") %>%
  select(date, collisions, type)

future_plot <- future_dates %>%
  select(date, predicted_collisions) %>%
  rename(collisions = predicted_collisions) %>%
  mutate(type = "Forecast")

final_plot <- rbind(plot_data, future_plot)

# Plot historical + forecasted collision trends
ggplot(final_plot, aes(x = date, y = collisions, color = type)) +
  geom_line(size = 1.1) +
  scale_color_manual(values = c("Historical" = "steelblue", "Forecast" = "red")) +
  labs(
    title = "Historical and Forecasted Collision Trends",
    x = "Date",
    y = "Number of Collisions",
    color = "Type"
  ) +
  theme_minimal()

```

# ---Spatial Analysis---
``` {r}
#Polygon map for spatial analysis
neigh <- st_read("neighbourhoods-4326.geojson")

neigh_utm <- st_transform(neigh, 32617)

#Removing invalid locations
dat_spatial <- dat_final %>%
  filter(neighbourhood != "NSA") %>%
  filter(lat_wgs84 !=0, long_wgs84 !=0) 

#Creating spatial object, assigning CRS
collisions_sf <- st_as_sf(dat_spatial, coords = c("long_wgs84","lat_wgs84"), crs = 4326)

#Reprojecting
collisions_utm <- st_transform(collisions_sf, 32617)

#plot the city outline
#plot(st_geometry(neigh_utm), border="black")

# toronto_boundary <- neigh_utm |>
#   st_union() |>
#   st_make_valid() |>
#   st_transform(32617)
# 
# coords <- st_coordinates(collisions_utm)
# win <- as.owin(toronto_boundary)
# collisions_ppp <- ppp(x=coords [,1], y=coords[,2], window=win)
# kde <- density.ppp(collisions_ppp, sigma=300, edge=TRUE)
# kde_df <- as.data.frame(kde)

# ggplot() +
#   geom_raster(data = kde_df, aes(x, y, fill = value)) +
#   geom_sf(data = toronto_boundary, color = "white", fill = NA, linewidth = 0.3) +
#   scale_fill_viridis_c(option = "heat") +
#   coord_sf() +
#   labs(title = "Toronto Traffic Collision Hotspots",
#        subtitle = "Kernel Density Estimation",
#        fill = "Density")

ggplot() +
  geom_sf(data = neigh, fill = "#f7f7f7", color = "white", linewidth=0.3) +
  geom_sf(data = collisions_sf, color = "red", size = 0.5, alpha =0.6) +
  geom_sf_text(data=st_point_on_surface(neigh),
               aes(label = AREA_NAME), size=2.5, color="black",
               check_overlap = TRUE) +
  labs(title = "Collisions in Toronto")


```

